name: Production Deployment

on:
  push:
    branches:
    - main

# ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸
concurrency:
  group: production-deploy
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: themacroeconomicdao/decentralized-social-platform/dsp-prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞ³ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ñ€Ğ°ÑÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ°
      - name: Set image tag
        id: vars
        run: echo "TAG=main-${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Pre-deployment diagnostics
        run: |
          echo "ğŸ” Pre-deployment cluster diagnostics:"
          echo "ğŸ“Š Node resources:"
          kubectl top nodes || echo "âš ï¸ Metrics server unavailable"
          
          echo "ğŸ“‹ Current pods:"
          kubectl get pods -n default -l app=dsp-prod
          
          echo "ğŸ“ˆ Current deployment status:"
          kubectl get deployment dsp-prod-deployment -n default -o wide
          
          echo "ğŸ”„ ReplicaSets:"
          kubectl get rs -n default -l app=dsp-prod --sort-by=.metadata.creationTimestamp

      - name: Deploy to k3s
        run: |
          echo "ğŸš€ Starting deployment..."
          
          # Apply manifests (creates or updates resources)
          kubectl apply -f k8s/prod/

          # Update image in deployment to the specific new sha
          echo "ğŸ”„ Updating deployment image..."
          kubectl set image deployment/dsp-prod-deployment dsp-prod=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }} -n default
          
          # Wait for rollout with detailed monitoring
          echo "â³ Waiting for rollout to complete..."
          if ! kubectl rollout status deployment/dsp-prod-deployment -n default --timeout=300s; then
            echo "âŒ Rollout failed! Gathering diagnostics..."
            
            echo "ğŸ“‹ Failed pods:"
            kubectl get pods -n default -l app=dsp-prod
            
            echo "ğŸ“ Recent events:"
            kubectl get events -n default --sort-by='.lastTimestamp' | tail -20
            
            echo "ğŸ” Pod details for failed pods:"
            kubectl get pods -n default -l app=dsp-prod -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.phase}{"\t"}{.status.containerStatuses[0].state}{"\n"}{end}'
            
            echo "ğŸ’¾ Describing problematic pods:"
            for pod in $(kubectl get pods -n default -l app=dsp-prod --field-selector=status.phase!=Running -o jsonpath='{.items[*].metadata.name}'); do
              echo "--- Pod: $pod ---"
              kubectl describe pod $pod -n default | tail -20
            done
            
            echo "ğŸ”„ Rolling back deployment..."
            kubectl rollout undo deployment/dsp-prod-deployment -n default
            exit 1
          fi
          
          echo "âœ… Deployment completed successfully!"

      - name: Post-deployment verification
        run: |
          echo "ğŸ” Post-deployment verification:"
          
          echo "ğŸ“Š Final pod status:"
          kubectl get pods -n default -l app=dsp-prod -o wide
          
          echo "ğŸŒ Service status:"
          kubectl get svc dsp-prod-service -n default
          
          echo "ğŸ”— Ingress/Gateway status:"
          kubectl get gateway dsp-prod-gateway -n default || echo "No gateway found"
          kubectl get virtualservice -n default -l app=dsp-prod
          
          echo "ğŸ¥ Health check:"
          for pod in $(kubectl get pods -n default -l app=dsp-prod -o jsonpath='{.items[*].metadata.name}'); do
            echo "Pod $pod readiness:"
            kubectl get pod $pod -n default -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
            echo ""
          done

      - name: Cleanup old ReplicaSets
        run: |
          echo "ğŸ§¹ Cleaning up old ReplicaSets (keeping last 3)..."
          kubectl get rs -n default -l app=dsp-prod --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | head -n -3 | xargs -r kubectl delete rs -n default

