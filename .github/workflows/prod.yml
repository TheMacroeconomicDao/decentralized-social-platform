name: Production Deployment

on:
  push:
    branches:
    - main

<<<<<<< HEAD
# ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¸
concurrency:
  group: production-deploy
  cancel-in-progress: true

=======
>>>>>>> 82ac3e08 (ðŸš€ Add production environment setup with k8s manifests and GitHub Actions workflow)
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: themacroeconomicdao/decentralized-social-platform/dsp-prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

<<<<<<< HEAD
      # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½ÑƒÐ¶Ð½Ñ‹Ð¹ Ñ‚ÐµÐ³ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð·, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ñ€Ð°ÑÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð°
      - name: Set image tag
        id: vars
        run: echo "TAG=main-${GITHUB_SHA}" >> $GITHUB_OUTPUT
=======
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest
>>>>>>> 82ac3e08 (ðŸš€ Add production environment setup with k8s manifests and GitHub Actions workflow)

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
<<<<<<< HEAD
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Verify image tag exists
        run: |
          sudo apt-get update && sudo apt-get install -y skopeo
          skopeo inspect docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }} >/dev/null
=======
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
>>>>>>> 82ac3e08 (ðŸš€ Add production environment setup with k8s manifests and GitHub Actions workflow)

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

<<<<<<< HEAD
      - name: Pre-deployment diagnostics
        run: |
          echo "ðŸ” Pre-deployment cluster diagnostics:"
          echo "ðŸ“Š Node resources:"
          kubectl top nodes || echo "âš ï¸ Metrics server unavailable"
          
          echo "ðŸ“‹ Current pods:"
          kubectl get pods -n default -l app=dsp-prod
          
          echo "ðŸ“ˆ Current deployment status:"
          kubectl get deployment dsp-prod-deployment -n default -o wide
          
          echo "ðŸ”„ ReplicaSets:"
          kubectl get rs -n default -l app=dsp-prod --sort-by=.metadata.creationTimestamp

      - name: Deploy to k3s
        run: |
          echo "ðŸš€ Starting deployment..."
          
          # Apply manifests via Kustomize overlay
          kubectl apply -k k8s/overlays/prod/

          # Update image in deployment to the specific new sha
          echo "ðŸ”„ Updating deployment image..."
          kubectl set image deployment/dsp-prod-deployment dsp-prod=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }} -n default
          
          # Wait for rollout with detailed monitoring
          echo "â³ Waiting for rollout to complete..."
          if ! kubectl rollout status deployment/dsp-prod-deployment -n default --timeout=300s; then
            echo "âŒ Rollout failed! Gathering diagnostics..."
            
            echo "ðŸ“‹ Failed pods:"
            kubectl get pods -n default -l app=dsp-prod
            
            echo "ðŸ“ Recent events:"
            kubectl get events -n default --sort-by='.lastTimestamp' | tail -20
            
            echo "ðŸ” Pod details for failed pods:"
            kubectl get pods -n default -l app=dsp-prod -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.phase}{"\t"}{.status.containerStatuses[0].state}{"\n"}{end}'
            
            echo "ðŸ’¾ Describing problematic pods:"
            for pod in $(kubectl get pods -n default -l app=dsp-prod --field-selector=status.phase!=Running -o jsonpath='{.items[*].metadata.name}'); do
              echo "--- Pod: $pod ---"
              kubectl describe pod $pod -n default | tail -20
            done
            
            echo "ðŸ”„ Rolling back deployment..."
            kubectl rollout undo deployment/dsp-prod-deployment -n default
            exit 1
          fi
          
          # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¶Ð´Ñ‘Ð¼ Ð°Ð²Ñ‚Ð¾Ð¼. Ð¿Ñ€Ð¾Ð¼Ð¾ÑƒÑ‚ ÐºÐ°Ð½Ð°Ñ€ÐµÐµÑ‡Ð½Ð¾Ð³Ð¾ Ñ€ÐµÐ»Ð¸Ð·Ð° (Flagger)
          # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 30Ð¼Ð¸Ð½, Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ (Flagger ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ event canary.failed)
          # ÐœÐ¾Ð¶Ð½Ð¾ ÑƒÐ±Ñ€Ð°Ñ‚ÑŒ, ÐµÑÐ»Ð¸ Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ Flagger
          # echo "â³ Waiting Flagger canary promotion (max 30m)..."
          # kubectl -n default wait canary/dsp-prod --for=jsonpath='{.status.phase}'=Succeeded --timeout=1800s || true
          
          echo "âœ… Deployment completed successfully!"

      - name: Post-deployment verification
        run: |
          echo "ðŸ” Post-deployment verification:"
          
          echo "ðŸ“Š Final pod status:"
          kubectl get pods -n default -l app=dsp-prod -o wide
          
          echo "ðŸŒ Service status:"
          kubectl get svc dsp-prod-service -n default
          
          echo "ðŸ”— Ingress/Gateway status:"
          kubectl get gateway dsp-prod-gateway -n default || echo "No gateway found"
          kubectl get virtualservice -n default -l app=dsp-prod
          
          echo "ðŸ¥ Health check:"
          for pod in $(kubectl get pods -n default -l app=dsp-prod -o jsonpath='{.items[*].metadata.name}'); do
            echo "Pod $pod readiness:"
            kubectl get pod $pod -n default -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
            echo ""
          done

      - name: Cleanup old ReplicaSets
        run: |
          echo "ðŸ§¹ Cleaning up old ReplicaSets (keeping last 3)..."
          kubectl get rs -n default -l app=dsp-prod --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | head -n -3 | xargs -r kubectl delete rs -n default

      # -------------------------------------------------
      # Telegram notifications
      # -------------------------------------------------
      - name: Notify Telegram success
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            -d text="âœ… PROD deploy succeeded: $GITHUB_SHA by $GITHUB_ACTOR"

      - name: Notify Telegram failure
        if: failure()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            -d text="âŒ PROD deploy FAILED: $GITHUB_SHA. Check Actions logs."

      # -------------------------------------------------
      # Security scanning â€” Ð¿Ð¾ÐºÐ° Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾, Ñ€Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸
      # -------------------------------------------------
      # - name: Trivy scan
      #   uses: aquasecurity/trivy-action@v0.19.0
      #   with:
      #     image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}
      #     format: table
      #     exit-code: 0  # Ð½Ðµ Ð¿Ð°Ð´Ð°ÐµÐ¼, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚

      # - name: Grype scan
      #   uses: anchore/scan-action@v3
      #   with:
      #     image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}
      #     fail-build: false
=======
      - name: Deploy to k3s
        run: |
          # Apply manifests (creates or updates resources)
          kubectl apply -f k8s/prod/

          # Update image in deployment to the specific new sha
          kubectl set image deployment/dsp-prod-deployment dsp-prod=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }} -n default
          
          # Wait for rollout
          kubectl rollout status deployment/dsp-prod-deployment -n default --timeout=600s

      - name: Get deployment status
        run: |
          kubectl get pods -n default -l app=dsp-prod
          kubectl get svc,ingress -n default | grep prod
>>>>>>> 82ac3e08 (ðŸš€ Add production environment setup with k8s manifests and GitHub Actions workflow)

