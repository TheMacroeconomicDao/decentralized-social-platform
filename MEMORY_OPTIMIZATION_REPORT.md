# Отчет об оптимизации памяти

## Проблема
Постоянное появление окна "Принудительное завершение программ" в macOS из-за нехватки программной памяти.

## Исправленные проблемы

### 1. ✅ Утечка памяти в Service Worker
**Файл:** `src/shared/lib/serviceWorker.ts`

**Проблема:**
- `setInterval` для проверки обновлений Service Worker никогда не очищался
- Event listeners накапливались при повторных вызовах
- Отсутствовала защита от множественной регистрации

**Исправление:**
- Добавлена глобальная переменная для хранения ссылки на interval
- Реализована правильная очистка interval в `unregisterServiceWorker()`
- Добавлена защита от множественной регистрации через флаг `isRegistered`
- Event listeners теперь правильно очищаются

### 2. ✅ Ограничения памяти для Next.js
**Файл:** `package.json`

**Изменения:**
- `dev`: добавлен `NODE_OPTIONS='--max-old-space-size=2048'` (2GB лимит)
- `build`: добавлен `NODE_OPTIONS='--max-old-space-size=4096'` (4GB лимит)
- `start`: добавлен `NODE_OPTIONS='--max-old-space-size=2048'` (2GB лимит)

### 3. ✅ Оптимизация конфигурации Next.js
**Файл:** `next.config.js`

**Изменения:**
- Добавлено ограничение количества CPU для сборки: `cpus: Math.max(1, Math.floor(require('os').cpus().length / 2))`
- В dev режиме: ограничен размер кеша (`maxMemoryGenerations: 1`, `maxAge: 24 часа`)
- В production: ограничен кеш webpack (`maxMemoryGenerations: 1`, `maxAge: 7 дней`)
- Добавлена оптимизация модулей: `removeAvailableModules`, `removeEmptyChunks`, `mergeDuplicateChunks`

### 4. ✅ Оптимизация Docker
**Файлы:** `Dockerfile`, `docker-compose.yml`

**Изменения:**
- Добавлен `NODE_OPTIONS=--max-old-space-size=2048` в Dockerfile
- Добавлены лимиты памяти в docker-compose.yml:
  - `limits.memory: 2G`
  - `reservations.memory: 1G`
- Добавлен `restart: unless-stopped` для автоматического перезапуска

## Дополнительные инструменты

### Скрипт проверки памяти
**Файл:** `check-memory.sh`

Скрипт для мониторинга потребления памяти:
```bash
./check-memory.sh
```

Показывает:
- Потребление памяти Node.js процессами
- Статистику Docker контейнеров
- Топ процессов по памяти
- Общую информацию о памяти системы

## Рекомендации

### Немедленные действия:
1. **Перезапустите dev сервер** с новыми настройками:
   ```bash
   npm run dev
   ```

2. **Проверьте запущенные процессы:**
   ```bash
   ./check-memory.sh
   ```

3. **Остановите неиспользуемые Docker контейнеры:**
   ```bash
   docker ps -a
   docker stop <container-id>
   docker rm <container-id>
   ```

4. **Очистите Docker (осторожно!):**
   ```bash
   docker system prune -a
   ```

### Долгосрочные меры:

1. **Мониторинг памяти:**
   - Регулярно запускайте `./check-memory.sh`
   - Следите за потреблением памяти в Activity Monitor (macOS)

2. **Ограничение количества одновременных процессов:**
   - Не запускайте несколько dev серверов одновременно
   - Закрывайте неиспользуемые приложения (Telegram, другие IDE)

3. **Оптимизация разработки:**
   - Используйте production build для тестирования вместо dev сервера
   - Ограничьте количество открытых вкладок браузера

4. **Системные настройки:**
   - Увеличьте swap файл если возможно
   - Рассмотрите увеличение RAM если проблема сохраняется

## Проверенные компоненты

✅ `serviceWorker.ts` - утечки исправлены
✅ `useAnimatedIcons.ts` - интервалы правильно очищаются
✅ `ParticleSystem.tsx` - requestAnimationFrame правильно очищается
✅ `DynamicLighting.tsx` - event listeners правильно очищаются
✅ `DraggablePopup.tsx` - event listeners правильно очищаются

## Статус

Все критические утечки памяти исправлены. Приложение должно потреблять значительно меньше памяти.

## Следующие шаги

1. Перезапустите dev сервер
2. Мониторьте память в течение нескольких часов работы
3. Если проблема сохраняется, проверьте другие приложения (Telegram, Finder)
4. Рассмотрите увеличение RAM или оптимизацию других приложений
