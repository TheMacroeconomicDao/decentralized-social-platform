apiVersion: batch/v1
kind: CronJob
metadata:
  name: cleanup-old-replicasets
  namespace: default
  labels:
    app: dsp-prod
    component: cleanup
spec:
  # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–π —á–∞—Å
  schedule: "0 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: dsp-prod
            component: cleanup
        spec:
          restartPolicy: OnFailure
          serviceAccountName: cleanup-service-account
          containers:
          - name: cleanup
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              echo "üßπ Cleaning up old ReplicaSets for dsp-prod..."
              
              # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ ReplicaSets, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è
              OLD_RS=$(kubectl get rs -n default -l app=dsp-prod --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | head -n -3)
              
              if [ -n "$OLD_RS" ]; then
                echo "üóëÔ∏è Deleting old ReplicaSets:"
                echo "$OLD_RS"
                echo "$OLD_RS" | xargs -r kubectl delete rs -n default
                echo "‚úÖ Cleanup completed"
              else
                echo "‚ÑπÔ∏è No old ReplicaSets to clean up"
              fi
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cleanup-service-account
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cleanup-role
  namespace: default
rules:
- apiGroups: ["apps"]
  resources: ["replicasets"]
  verbs: ["get", "list", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cleanup-role-binding
  namespace: default
subjects:
- kind: ServiceAccount
  name: cleanup-service-account
  namespace: default
roleRef:
  kind: Role
  name: cleanup-role
  apiGroup: rbac.authorization.k8s.io 